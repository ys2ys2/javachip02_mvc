<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.human.web.mapper.TravelPostMapper">

    <!-- 여행기 등록: useGeneratedKeys 설정으로 tp_idx 값을 가져옴 -->
    <!-- 여행기 데이터를 DB에 삽입하는 쿼리. 여행기 등록 후, 자동으로 생성된 tp_idx 값이 TravelPostVO 객체의 tp_idx 필드에 자동으로 설정됨. -->
    <insert id="insertTravelPost" parameterType="TravelPostVO" useGeneratedKeys="true" keyProperty="tp_idx">
        INSERT INTO tb_travel_post (title, content, topic, post_date) 
        VALUES (#{title}, #{content}, #{topic}, NOW())
    </insert>

    <!-- 태그 등록 -->
    <!-- 여행기에 연결된 태그를 DB에 저장하는 쿼리. 태그와 여행기의 연관을 위해 tp_idx와 tag를 사용. -->
    <insert id="insertTag" parameterType="map">
        INSERT INTO tb_travel_tags (tp_idx, tag_name)
        VALUES (#{tp_idx}, #{tag})
    </insert>
    
    <!-- 태그 중복 확인 -->
    <!-- 특정 여행기와 태그가 이미 존재하는지 중복 여부를 확인하는 쿼리. 동일한 tp_idx와 태그가 있는지 체크하여 중복 태그 방지. -->
	<select id="checkDuplicateTag" parameterType="map" resultType="int">
    	SELECT COUNT(*) 
    	FROM tb_travel_tags 
    	WHERE tp_idx = #{tp_idx} 
      	AND tag_name = #{tag}
	</select>
    

     <!-- 여행기 목록 조회 -->
     <!-- 모든 여행기 데이터를 DB에서 가져오는 쿼리. 최신 순으로 정렬됨. -->
    <select id="getAllPosts" resultType="TravelPostVO">
        SELECT * FROM tb_travel_post ORDER BY post_date DESC
    </select> 

    <!-- 특정 여행기 조회 -->
    <!-- 특정 tp_idx에 해당하는 하나의 여행기 데이터를 조회하는 쿼리. 여행기 상세 페이지를 위해 사용. -->
    <select id="getTravelPost" parameterType="int" resultType="TravelPostVO">
        SELECT * FROM tb_travel_post WHERE tp_idx = #{tp_idx}
    </select>

    <!-- 첨부파일 등록 -->
    <!-- 여행기에 연결된 첨부파일 정보를 DB에 저장하는 쿼리. 파일명, 파일 크기, 파일 유형 등을 함께 저장. -->
    <insert id="insertTravelMedia" parameterType="TravelMediaVO">
        INSERT INTO tb_travel_media (tp_idx, origin_filename, save_filename, file_type, file_size, upload_date)
        VALUES (#{tp_idx}, #{origin_filename}, #{save_filename}, #{file_type}, #{file_size}, NOW())
    </insert>

    <!-- 태그별 최신 게시물 조회 -->
    <!-- 특정 태그에 연결된 최신 여행기 데이터를 제한된 개수만 가져오는 쿼리. 태그에 해당하는 게시물 중에서 최신 순으로 정렬하여 limit 개수만큼 가져옴. -->
    <select id="selectRecentPostsByTag" parameterType="map" resultType="TravelPostVO">
        SELECT p.* 
        FROM tb_travel_post p
        JOIN tb_travel_tags t ON p.tp_idx = t.tp_idx
        WHERE t.tag_name = #{tag}
        ORDER BY p.post_date DESC
        LIMIT #{limit}
    </select>
    
</mapper>
