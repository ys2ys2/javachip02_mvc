<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ page import="com.human.web.repository.PostDAO, com.human.web.vo.PostVO" %>
<%@ page import="com.human.web.repository.TravelPostDAO, com.human.web.vo.TravelPostVO" %>

<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %><fmt:setTimeZone value="UTC" />
<%@ page import="java.util.List" %>

<%
// DAO Í∞ùÏ≤¥ ÏÉùÏÑ± Î∞è Í≤åÏãúÍ∏Ä Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
    PostDAO postDAO = new PostDAO();
    List<PostVO> postList = postDAO.getAllPosts();

    // postListÎ•º request Í∞ùÏ≤¥Ïóê Î∞îÏù∏Îî©ÌïòÏó¨ JSTL ÌÉúÍ∑∏ÏóêÏÑú Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù ÏÑ§Ï†ï
    request.setAttribute("postList", postList);
%>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Community</title>
  	<link href="${pageContext.request.contextPath}/resources/css/header.css" rel="stylesheet" type="text/css"> <!-- header.css -->
	<link href="${pageContext.request.contextPath}/resources/css/footer.css" rel="stylesheet" type="text/css"> <!-- footer.css -->
	<link href="${pageContext.request.contextPath}/resources/css/c_mainstyles.css" rel="stylesheet" type="text/css"> <!-- c_mainstyles.css -->
    <link href="${pageContext.request.contextPath}/resources/css/post_modal.css" rel="stylesheet" type="text/css"> <!-- post_modal.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
	<div class="overlay"></div>

    <header>
        <div class="header-container">
            <div class="logo" data-ko="BBOL BBOL BBOL" data-en="BBOL BBOL BBOL">BBOL BBOL BBOL</div>
            <nav>
                <ul>
                    <li><a href="#" data-ko="Ìôà" data-en="Home">Ìôà</a></li>
                    <li><a href="#" data-ko="Ïª§ÎÆ§ÎãàÌã∞" data-en="Community">Ïª§ÎÆ§ÎãàÌã∞</a></li>
                    <li><a href="#" data-ko="Ïó¨ÌñâÏßÄ" data-en="RecoHotPlace">Ïó¨ÌñâÏßÄ</a></li>
                    <li><a href="#" data-ko="Ïó¨ÌñâÎΩàÎΩà" data-en="BBOL BBOL BBOL">Ïó¨ÌñâÎΩàÎΩà</a></li>
                    <button class="search-btn">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
          			<button class="user-btn" onclick="location.href='${pageContext.request.contextPath}/Login/login'">
                        <i class="fa-solid fa-user"></i>
                    </button>
                    <button class="earth-btn">
                        <i class="fa-solid fa-earth-americas"></i>
                    </button>
                    <button class="korean" id="lang-btn" data-lang="ko">English</button>
                </ul>
            </nav>
        </div>
    </header>
	
	
    <div class="container">
        <!-- Í≤åÏãúÍ∏Ä Î™©Î°ù ÏòÅÏó≠ -->
        <div class="left-content">
            <div class="post-header">
                <h2>Í≤åÏãúÍ∏Ä Î™©Î°ù</h2>
                <button class="modal-button" id="openPostModal">Í≤åÏãúÍ∏Ä ÏûëÏÑ±</button>
            </div>

            <!-- Í≤åÏãúÍ∏Ä Î™©Î°ù -->
            <div id="postList">
                <c:forEach var="post" items="${postList}">
                    <div class="post" data-post-id="${post.postId}">
                           <div class="post-user">
                           <span class="username">${post.username}</span> ¬∑ <span class="follow">ÌåîÎ°úÏö∞</span>
                            <!-- Í≤åÏãúÍ∏Ä ÏûëÏÑ± ÏãúÍ∞Ñ ÌëúÏãú -->
                          <span class="created-time">
                              <fmt:formatDate value="${post.createdAt}" pattern="yyyy-MM-dd HH:mm"/>
                          </span>
                    </div>
                        <p class="post-content">${post.content}</p>
                        <div class="post-footer">
                            <span class="like-count">‚ù§Ô∏è Ï¢ãÏïÑÏöî: ${post.likeCount}</span>
                            <span class="comment-count">üí¨ ÎåìÍ∏Ä: ${post.commentCount}</span>
                        </div>
                    </div>
                </c:forEach>
            </div>
        </div>
        
     <!-- Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Î≥¥Í∏∞ Î™®Îã¨ -->
<div id="postDetailModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeDetailModal">&times;</span>
        <div id="modal-post-content">
            <!-- Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ ÎÇ¥Ïö© ÌëúÏãú -->
            <c:forEach var="post" items="${postDetail}">
                <div class="post-detail-header">
                    <h2>ÏûëÏÑ±Ïûê: ${post.username}</h2>
                    <span class="created-time">
                        <!-- Í≤åÏãúÍ∏Ä ÏûëÏÑ± ÏãúÍ∞Ñ ÌëúÏãú (ÏÜåÏàòÏ†ê Ï†úÍ±∞) -->
                        <fmt:formatDate value="${post.createdAt}" pattern="yyyy-MM-dd HH:mm:ss"/>
                    </span>
                </div>
                <div class="post-detail-content">
                    <p>${post.content}</p>
                </div>
                <div class="post-detail-footer">
                    <span class="like-count">Ï¢ãÏïÑÏöî Ïàò: ${post.likeCount}</span>
                    <span class="comment-count">ÎåìÍ∏Ä Ïàò: ${post.commentCount}</span>
                </div>
            </c:forEach>
        </div>

        <!-- ÎåìÍ∏Ä Î™©Î°ù -->
        <div id="modal-comments">
            <c:forEach var="comment" items="${commentList}">
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-username">${comment.username}</span>
                        <span class="comment-created-time">
                            <!-- ÎåìÍ∏Ä ÏûëÏÑ± ÏãúÍ∞Ñ ÌëúÏãú -->
                            <fmt:formatDate value="${comment.createdAt}" pattern="yyyy-MM-dd HH:mm:ss"/>
                        </span>
                    </div>
                    <div class="comment-content">
                        ${comment.content}
                    </div>
                </div>
            </c:forEach>
        </div>

        <!-- ÎåìÍ∏Ä ÏûÖÎ†• ÏòÅÏó≠ -->
        <div class="comment-input">
            <textarea id="modalCommentContent" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
            <div class="button-group">
                <button class="modal-button" id="submitComment">ÎåìÍ∏Ä ÏûëÏÑ±</button>
                <button class="modal-button" id="likeBtn">Ï¢ãÏïÑÏöî</button>
            </div>
        </div>
    </div>
</div>
     

        <!-- Ïò§Î•∏Ï™Ω ÌÉúÍ∑∏ Î∞è Ïó¨ÌñâÍ∏∞ Î™©Î°ù ÏòÅÏó≠ -->
        <div class="right-content">
            <!-- Ïó¨ÌñâÍ∏∞ ÏûëÏÑ± Î≤ÑÌäº -->
		<button class="modal-button travel-write-button" onclick="location.href='${pageContext.request.contextPath}/Community/c_board/travelWrite'">Ïó¨ÌñâÍ∏∞ ÏûëÏÑ±</button>

            <!-- ÏÑúÏö∏ Ïó¨ÌñâÍ∏∞ Î™©Î°ù -->
            <div class="tag-section" id="seoul-section">
                <h3>#ÏÑúÏö∏ Ïó¨Ìñâ</h3>
                <div class="tag-travel-posts" id="seoulPostList">
                    <c:forEach var="travelPost" items="${seoulPosts}">
                        <div class="travel-post-card">
                            <img src="../${travelPost.imagePath}" alt="${travelPost.title}" class="travel-post-image"/>
                            <p class="travel-post-title">${travelPost.title}</p>
                        </div>
                    </c:forEach>
                </div>
            </div>

            <!-- Î∂ÄÏÇ∞ Ïó¨ÌñâÍ∏∞ Î™©Î°ù -->
            <div class="tag-section" id="busan-section">
                <h3>#Î∂ÄÏÇ∞ Ïó¨Ìñâ</h3>
                <div class="tag-travel-posts" id="busanPostList">
                    <c:forEach var="travelPost" items="${busanPosts}">
                        <div class="travel-post-card">
                            <img src="../${travelPost.imagePath}" alt="${travelPost.title}" class="travel-post-image"/>
                            <p class="travel-post-title">${travelPost.title}</p>
                        </div>
                    </c:forEach>
                </div>
            </div>

            <!-- Ï†úÏ£º Ïó¨ÌñâÍ∏∞ Î™©Î°ù -->
            <div class="tag-section" id="jeju-section">
                <h3>#Ï†úÏ£º Ïó¨Ìñâ</h3>
                <div class="tag-travel-posts" id="jejuPostList">
                    <c:forEach var="travelPost" items="${jejuPosts}">
                        <div class="travel-post-card">
                            <img src="../${travelPost.imagePath}" alt="${travelPost.title}" class="travel-post-image"/>
                            <p class="travel-post-title">${travelPost.title}</p>
                        </div>
                    </c:forEach>
                </div>
            </div>

            <!-- Ïù∏Ï≤ú Ïó¨ÌñâÍ∏∞ Î™©Î°ù -->
            <div class="tag-section" id="incheon-section">
                <h3>#Ïù∏Ï≤ú Ïó¨Ìñâ</h3>
                <div class="tag-travel-posts" id="incheonPostList">
                    <c:forEach var="travelPost" items="${incheonPosts}">
                        <div class="travel-post-card">
                            <img src="../${travelPost.imagePath}" alt="${travelPost.title}" class="travel-post-image"/>
                            <p class="travel-post-title">${travelPost.title}</p>
                        </div>
                    </c:forEach>
                </div>
            </div>
        </div>
    </div>

    <!-- Í≤åÏãúÍ∏Ä ÏûëÏÑ± Î™®Îã¨ -->
    <div id="postWriteModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closePostWriteModal">&times;</span>
            <h2>Í≤åÏãúÍ∏Ä ÏûëÏÑ±</h2>
            <form id="postForm">
                <label for="modalPostContent">ÎÇ¥Ïö©*</label>
                <textarea id="modalPostContent" placeholder="Ïó¨Ìñâ ÏßàÎ¨∏Ïù¥ÎÇò Ï†ïÎ≥¥Î•º Í≥µÏú†Ìï¥Î≥¥ÏÑ∏Ïöî!" minlength="5" maxlength="1000" required></textarea>
                <p>(ÏµúÏÜå 5Ïûê Ïù¥ÏÉÅ / ÏµúÎåÄ 1,000Ïûê Ïù¥ÎÇ¥)</p>

                <!-- ÌååÏùº ÏóÖÎ°úÎìú ÏÑ†ÌÉù ÏòÅÏó≠ -->
                <div class="form-group">
                    <label for="file-upload" class="custom-file-upload">ÌååÏùº ÏÑ†ÌÉù</label>
                    <input id="file-upload" type="file" style="display:none;">
                    <span id="file-selected">ÏÑ†ÌÉùÎêú ÌååÏùº ÏóÜÏùå</span>
                </div>

                <!-- Î™®Îã¨ ÌïòÎã® Î≤ÑÌäº ÏòÅÏó≠ -->
                <div class="modal-footer">
                    <button class="modal-button" type="submit" id="submitPostModal">Í≤åÏãúÍ∏Ä ÏûëÏÑ± ÏôÑÎ£å</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Ìë∏ÌÑ∞ Î∂ÄÎ∂Ñ -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h4>ÌöåÏÇ¨ÏÜåÍ∞ú</h4>
                <ul>
                    <li><a href="#">ÌöåÏÇ¨ÏÜåÍ∞ú</a></li>
                    <li><a href="#">Î∏åÎûúÎìú Ïù¥ÏïºÍ∏∞</a></li>
                    <li><a href="#">Ï±ÑÏö©Í≥µÍ≥†</a></li>
                </ul>
            </div>

            <!-- Í≥†Í∞ùÏßÄÏõê -->
            <div class="footer-section">
                <h4>Í≥†Í∞ùÏßÄÏõê</h4>
                <ul>
                    <li><a href="#">Í≥µÏßÄÏÇ¨Ìï≠</a></li>
                    <li><a href="#">ÏûêÏ£ºÎ¨ªÎäî ÏßàÎ¨∏</a></li>
                    <li><a href="#">Î¨∏ÏùòÌïòÍ∏∞</a></li>
                </ul>
            </div>

            <!-- Ïù¥Ïö©ÏïΩÍ¥Ä -->
            <div class="footer-section">
                <h4>Ïù¥Ïö©ÏïΩÍ¥Ä</h4>
                <ul>
                    <li><a href="#">Ïù¥Ïö©ÏïΩÍ¥Ä</a></li>
                    <li><a href="#">Í∞úÏù∏Ï†ïÎ≥¥Ï≤òÎ¶¨Î∞©Ïπ®</a></li>
                    <li><a href="#">Ï†ÄÏûëÍ∂å Î≥¥Ìò∏Ï†ïÏ±Ö</a></li>
                </ul>
            </div>

            <!-- ÌöåÏÇ¨ Ï†ïÎ≥¥ -->
            <div class="footer-company-info">
                <p>ÏÉÅÌò∏: (Ï£º)BBOL | ÎåÄÌëú: Î∞ïÏòàÏä¨ | ÏÇ¨ÏóÖÏûêÎì±Î°ùÎ≤àÌò∏: 123-45-67890 | ÌÜµÏã†ÌåêÎß§ÏóÖ Ïã†Í≥†Î≤àÌò∏: 2024-Ï∂©ÎÇ®Ï≤úÏïà-00000 | Í∞úÏù∏Ï†ïÎ≥¥Í¥ÄÎ¶¨ Ï±ÖÏûÑÏûê: ÏàòÏàòÏò•</p>
                <p>Ï£ºÏÜå: Ï∂©Ï≤≠ÎÇ®ÎèÑ Ï≤úÏïàÏãú ÎèôÎÇ®Íµ¨ 123 | Ïù¥Î©îÏùº: support@BBOL3.com | ÎåÄÌëúÏ†ÑÌôî: 02-1234-5678</p>
                <p>¬© 2024 BBOLBBOLBBOL. All Rights Reserved.</p>
            </div>

            <!-- ÏÜåÏÖú ÎØ∏ÎîîÏñ¥ -->
            <div class="footer-social">
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </footer>

    <script>
    $(document).ready(function () {
    	
    	// Í≤åÏãúÍ∏Ä ÏûëÏÑ± Î™®Îã¨ Ïó¥Í∏∞
        $('#openPostModal').on('click', function () {
            $('#postWriteModal').css('display', 'block');
        });

        // Í≤åÏãúÍ∏Ä ÏûëÏÑ± Î™®Îã¨ Îã´Í∏∞
        $('#closePostWriteModal').on('click', function () {
            $('#postWriteModal').css('display', 'none');
        });

        // Í≤åÏãúÍ∏Ä ÏûëÏÑ± Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨
        $('#postForm').on('submit', function (event) {
            event.preventDefault();

            var content = $('#modalPostContent').val();
            var imageFile = $('#file-upload').prop('files')[0];

            if (content.trim() === "") {
                alert("ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
                return;
            }

            var formData = new FormData();
            formData.append('content', content);
            if (imageFile) {
                formData.append('image', imageFile);
            }

            $.ajax({
                type: 'POST',
                url: 'savePost.jsp',
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    alert("Í≤åÏãúÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
                    $('#postWriteModal').css('display', 'none');
                    $('#modalPostContent').val('');
                    $('#file-upload').val('');
                    loadPosts();  // Í≤åÏãúÍ∏Ä Î™©Î°ù Í∞±Ïã†
                },
                error: function () {
                    alert("Í≤åÏãúÍ∏Ä Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                }
            });
        });

        // Í≤åÏãúÍ∏Ä Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
        function loadPosts() {
            $.ajax({
                type: 'GET',
                url: 'loadPosts.jsp',
                success: function (response) {
                    $('#postList').html(response);
                },
                error: function () {
                    alert("Í≤åÏãúÍ∏Ä Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                }
            });
        }


        // Í≤åÏãúÍ∏Ä ÌÅ¥Î¶≠ Ïãú ÏÉÅÏÑ∏ Î™®Îã¨ Ïó¥Í∏∞
        $('#postList').on('click', '.post', function () {
            var postId = $(this).data('post-id');
            openPostDetailModal(postId);
        });

        // Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Î™®Îã¨ Ïó¥Í∏∞ Ìï®Ïàò
        function openPostDetailModal(postId) {
            $.ajax({
                type: 'GET',
                url: 'getPostDetail.jsp',
                data: { postId: postId },
                success: function (response) {
                    $('#modal-post-content').html(response);
                    updateComments(postId);
                    $('#postDetailModal').css('display', 'block');
                    setCommentAndLikeHandlers(postId);
                },
                error: function () {
                    alert("Í≤åÏãúÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                }
            });
        }

        // ÎåìÍ∏Ä Î∞è Ï¢ãÏïÑÏöî Ìï∏Îì§Îü¨ ÏÑ§Ï†ï
        function setCommentAndLikeHandlers(postId) {
            // ÎåìÍ∏Ä ÏûëÏÑ± Ïù¥Î≤§Ìä∏
            $('#submitComment').off('click').on('click', function () {
                var commentContent = $('#modalCommentContent').val();
                if (commentContent.trim() === '') {
                    alert("ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!");
                    return;
                }

                $.ajax({
                    type: 'POST',
                    url: 'saveComment.jsp',
                    data: { postId: postId, content: commentContent },
                    success: function () {
                        $('#modalCommentContent').val('');
                        updateComments(postId);
                    },
                    error: function () {
                        alert("ÎåìÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                    }
                });
            });

            // Ï¢ãÏïÑÏöî ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            $('#likeBtn').off('click').on('click', function () {
                $.ajax({
                    type: 'POST',
                    url: 'toggleLike.jsp',
                    data: { postId: postId },
                    success: function () {
                        updateLikeCount(postId);
                    },
                    error: function () {
                        alert("Ï¢ãÏïÑÏöî Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                    }
                });
            });
        }

        // ÎåìÍ∏Ä Î™©Î°ùÏùÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Ìï®Ïàò
        function updateComments(postId) {
            $.ajax({
                type: 'GET',
                url: 'getComments.jsp',
                data: { postId: postId },
                success: function (response) {
                    $('#modal-comments').html(response);
                },
                error: function () {
                    alert("ÎåìÍ∏Ä Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                }
            });
        }

        // Ï¢ãÏïÑÏöî ÏàòÎ•º ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Ìï®Ïàò
        function updateLikeCount(postId) {
            $.ajax({
                type: 'GET',
                url: 'getPostDetail.jsp',
                data: { postId: postId },
                success: function (response) {
                    $('#modal-post-content').html(response);
                },
                error: function () {
                    alert("Ï¢ãÏïÑÏöî Ïàò ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®");
                }
            });
        }

        // Î™®Îã¨ Îã´Í∏∞ Î≤ÑÌäº
        $('#closeDetailModal').on('click', function () {
            $('#postDetailModal').css('display', 'none');
        });
    });
    </script>
    
   
    
</body>
</html>
